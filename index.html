<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Vocabulary Manager</title>
    
    <!-- PWA & Mobile Configuration START -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- PWA & Mobile Configuration END -->
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- 1. Name Entry Modal (Initial Splash Screen) -->
    <div id="name-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">Welcome Back!</h2>
            <p class="text-gray-600 mb-6">Enter your name to load your personalized lists. (Your last name is pre-filled.)</p>
            <input type="text" id="user-name-input" placeholder="Your Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <button id="start-app-button" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md disabled:bg-blue-400">
                Start Managing Lists
            </button>
            <p id="name-error-message" class="mt-3 text-sm text-red-600 hidden"></p>
        </div>
    </div>

    <!-- 2. Main Application UI (Hidden until name entered) -->
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700">Vocab Manager</h1>
            <p class="text-gray-500 mt-1">Hello, <span id="current-user-display" class="font-semibold text-blue-600">User</span>! Manage your lists here.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- List Management Panel (Col 1) -->
            <section class="md:col-span-1 bg-white p-5 shadow-lg rounded-xl h-fit">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="ph-folders text-blue-500 mr-2"></i> Your Lists
                </h2>

                <div id="list-names-container" class="space-y-2 mb-6">
                    <!-- List names will load here -->
                    <p id="loading-lists-indicator" class="text-center py-2 text-sm text-gray-400">Loading...</p>
                    <p id="no-lists-message" class="text-center py-2 text-sm text-gray-400 hidden">No lists found. Create one!</p>
                </div>
                
                <h3 class="text-lg font-medium text-gray-700 mb-3 border-t pt-4">Create New List</h3>
                <input type="text" id="new-list-name-input" placeholder="New List Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 mb-2">
                <button id="create-list-button" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700 transition duration-200 shadow-md disabled:bg-green-400">
                    <i class="ph-plus-circle mr-1"></i> Create List
                </button>
            </section>


            <!-- List Item Management Panel (Cols 2 & 3) -->
            <section class="md:col-span-2 space-y-6">

                <!-- Currently Selected List Name -->
                <div class="p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-blue-800">Editing List:</p>
                    <h2 id="current-list-name-display" class="text-2xl font-bold text-blue-900">Please Select a List</h2>
                </div>


                <!-- Item Creation Form -->
                <div id="item-creation-form" class="bg-white p-5 shadow-lg rounded-xl hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="ph-pencil-line text-blue-500 mr-2"></i> Add Item
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="term-input" placeholder="Vocabulary Term (e.g., Ephemeral)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <textarea id="definition-input" placeholder="Definition or Context" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-none h-20"></textarea>
                        <button id="add-item-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md disabled:bg-blue-400">
                            <i class="ph-plus-circle mr-2"></i> Add Item
                        </button>
                    </div>
                    <p id="error-message" class="mt-3 text-sm text-red-600 hidden"></p>
                </div>

                <!-- Item Display -->
                <div class="bg-white p-5 shadow-lg rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="ph-list-checks text-blue-500 mr-2"></i> List Contents
                    </h3>
                    <div id="loading-items-indicator" class="text-center py-6 text-gray-400">
                        <p>Select a list above to view its contents.</p>
                    </div>
                    <div id="vocab-list-container" class="space-y-3">
                        <!-- List items will be rendered here -->
                    </div>
                    <p id="empty-list-message" class="text-center text-gray-400 py-6 hidden">This list is empty. Add a term!</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal/Message Box (for non-alert messages) -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold mb-2 text-gray-800"></h3>
            <p id="message-content" class="text-sm text-gray-600 mb-4"></p>
            <button id="message-close-button" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">Close</button>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        // Import Firebase modules
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {};
        
        const APP_ID = typeof __app_id !== 'undefined'
            ? __app_id
            : 'default-app-id';

        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined'
            ? __initial_auth_token
            : null;
            
        // --- Application State ---
        let app;
        let db;
        let auth;
        let userName = null; 
        let currentListId = null; 
        let currentListName = null;
        let unsubscribeItemsSnapshot = null;
        let unsubscribeListNamesSnapshot = null;
        
        // CRITICAL: Promise to ensure Firebase is fully initialized before starting data operations
        let firebaseInitResolve;
        const firebaseInitPromise = new Promise(resolve => {
            firebaseInitResolve = resolve;
        });


        // --- DOM Elements ---
        const nameModal = document.getElementById('name-modal');
        const appContainer = document.getElementById('app');
        const userNameInput = document.getElementById('user-name-input');
        const startAppButton = document.getElementById('start-app-button');
        const nameErrorMessage = document.getElementById('name-error-message');
        const currentUserDisplay = document.getElementById('current-user-display');
        const listNamesContainer = document.getElementById('list-names-container');
        const loadingListsIndicator = document.getElementById('loading-lists-indicator');
        const noListsMessage = document.getElementById('no-lists-message');
        const newListInput = document.getElementById('new-list-name-input');
        const createListButton = document.getElementById('create-list-button');
        const currentListNameDisplay = document.getElementById('current-list-name-display');
        const itemCreationForm = document.getElementById('item-creation-form');
        const vocabListContainer = document.getElementById('vocab-list-container');
        const emptyListMessage = document.getElementById('empty-list-message');
        const termInput = document.getElementById('term-input');
        const definitionInput = document.getElementById('definition-input');
        const addItemButton = document.getElementById('add-item-button');
        const errorMessage = document.getElementById('error-message');

        // --- Utility Functions ---

        function showMessage(title, content) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            document.getElementById('message-box').classList.remove('hidden');
        }

        document.getElementById('message-close-button').addEventListener('click', () => {
            document.getElementById('message-box').classList.add('hidden');
        });

        function displayError(message) {
            console.error(message);
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        function sanitizeName(name) {
            if (!name) return null;
            return name.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        // --- Firestore Path Helpers ---

        function getUserListsCollectionRef(key) {
            if (!db || !key) return null;
            return collection(db, 'artifacts', APP_ID, 'public', 'data', 'user_data', key, 'lists');
        }

        function getListItemsCollectionRef(listId) {
            if (!db || !userName || !listId) return null;
            return collection(db, 'artifacts', APP_ID, 'public', 'data', 'user_data', userName, 'lists', listId, 'items');
        }

        // --- Core Application Logic ---
        
        /** Starts the real-time listener for the user's list names (left panel). */
        function startListNamesListener(userKey) {
            if (unsubscribeListNamesSnapshot) {
                unsubscribeListNamesSnapshot();
            }
            
            loadingListsIndicator.textContent = "Loading...";
            loadingListsIndicator.classList.remove('hidden');

            const listsRef = getUserListsCollectionRef(userKey);
            if (!listsRef) {
                 displayError("Cannot start list listener: Database not ready or user key missing. Please report this error.");
                 return;
            }
            
            console.log(`[DEBUG] Attempting to load lists for Firestore ID: ${userKey}`);
            console.log(`[DEBUG] Full Collection Path: ${listsRef.path}`);
            
            unsubscribeListNamesSnapshot = onSnapshot(listsRef, (snapshot) => {
                const listDocs = [];
                snapshot.forEach(doc => {
                    listDocs.push({
                        id: doc.id,
                        name: doc.data().name || doc.id
                    });
                });
                renderListNames(listDocs);

                // If no list is selected, auto-select the first one if it exists
                if (listDocs.length > 0 && !currentListId) {
                    switchToList(listDocs[0].id, listDocs[0].name);
                }
            }, (error) => {
                console.error("Firestore List Names Error:", error);
                loadingListsIndicator.textContent = "Error loading lists. Check console for details.";
                displayError("Failed to fetch lists: " + error.message);
            });
        }
        
        /** Renders the list names in the left panel. */
        function renderListNames(listDocs) {
            listNamesContainer.innerHTML = '';
            loadingListsIndicator.classList.add('hidden');
            noListsMessage.classList.add('hidden');

            if (listDocs.length === 0) {
                noListsMessage.classList.remove('hidden');
                return;
            }

            listDocs.forEach(list => {
                const button = document.createElement('button');
                button.textContent = list.name;
                button.setAttribute('data-id', list.id);
                // Correctly set class based on currentListId
                button.className = `w-full text-left p-3 rounded-lg font-medium transition duration-150 shadow-sm ${list.id === currentListId ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-100 text-gray-800 hover:bg-blue-100'}`;
                
                button.addEventListener('click', () => switchToList(list.id, list.name));
                listNamesContainer.appendChild(button);
            });
        }

        /** Switches the UI and listener to a specific list. */
        function switchToList(listId, listName) {
            if (unsubscribeItemsSnapshot) {
                unsubscribeItemsSnapshot();
            }

            currentListId = listId;
            currentListName = listName;
            currentListNameDisplay.textContent = listName;
            itemCreationForm.classList.remove('hidden');
            document.getElementById('loading-items-indicator').classList.add('hidden');
            
            // Update button styles immediately
            document.querySelectorAll('#list-names-container button').forEach(btn => {
                if (btn.getAttribute('data-id') === listId) {
                    btn.className = 'w-full text-left p-3 rounded-lg font-medium transition duration-150 shadow-sm bg-blue-500 text-white hover:bg-blue-600';
                } else {
                    btn.className = 'w-full text-left p-3 rounded-lg font-medium transition duration-150 shadow-sm bg-gray-100 text-gray-800 hover:bg-blue-100';
                }
            });


            const itemsRef = getListItemsCollectionRef(listId);
            if (!itemsRef) return;

            unsubscribeItemsSnapshot = onSnapshot(itemsRef, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    items.push({
                        id: doc.id,
                        term: data.term,
                        definition: data.definition,
                        timestamp: data.created ? data.created.toMillis() : Date.now(), 
                    });
                });
                renderListItems(items);
            }, (error) => {
                displayError("Error fetching list items: " + error.message);
            });
        }
        
        /** Renders the vocabulary items for the currently selected list. */
        function renderListItems(items) {
            vocabListContainer.innerHTML = '';
            emptyListMessage.classList.add('hidden');

            if (items.length === 0) {
                emptyListMessage.classList.remove('hidden');
                return;
            }

            items.sort((a, b) => b.timestamp - a.timestamp);

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-50 p-4 border border-gray-200 rounded-lg shadow-sm flex justify-between items-start transition duration-150 hover:shadow-md';
                itemDiv.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-bold text-gray-900">${item.term}</h3>
                        <p class="text-sm text-gray-600 mt-1">${item.definition}</p>
                    </div>
                    <button data-id="${item.id}" class="delete-btn flex-shrink-0 ml-4 p-2 text-red-500 hover:text-red-700 transition duration-150">
                        <i class="ph-trash-simple text-xl"></i>
                    </button>
                `;
                vocabListContainer.appendChild(itemDiv);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    handleDeleteItem(id);
                });
            });
        }


        // --- Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            const lastUserName = localStorage.getItem('lastUserName');
            if (lastUserName) {
                userNameInput.value = lastUserName;
            }
        });


        // 1. Name Submission
        startAppButton.addEventListener('click', async () => {
            const rawName = userNameInput.value.trim();
            if (rawName.length < 3) {
                nameErrorMessage.textContent = "Please enter a name with at least 3 characters.";
                nameErrorMessage.classList.remove('hidden');
                return;
            }
            
            const safeName = sanitizeName(rawName);
            
            console.log(`[DEBUG] User Input: ${rawName}`);
            console.log(`[DEBUG] Sanitized ID (used for Firestore path): ${safeName}`);
            
            // IMPORTANT: Wait for Firebase to fully initialize before attempting data load
            try {
                startAppButton.disabled = true;
                startAppButton.textContent = "Connecting...";
                await firebaseInitPromise; 
            } catch (error) {
                nameErrorMessage.textContent = "FATAL: Connection failed. Please check console.";
                nameErrorMessage.classList.remove('hidden');
                startAppButton.disabled = false;
                startAppButton.textContent = "Start Managing Lists";
                return;
            }
            
            startAppButton.textContent = "Start Managing Lists";
            startAppButton.disabled = false;

            userName = safeName; 
            currentUserDisplay.textContent = rawName; 
            localStorage.setItem('lastUserName', rawName); 
            
            nameModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Firebase is now guaranteed to be ready.
            startListNamesListener(safeName);
        });

        // 2. New List Creation
        createListButton.addEventListener('click', async () => {
            const listName = newListInput.value.trim();
            if (!userName) {
                 showMessage("Error", "Please enter your name first.");
                 return;
            }
            if (listName.length < 3) {
                showMessage("Input Error", "The new list name must be at least 3 characters long.");
                return;
            }

            const listsRef = getUserListsCollectionRef(userName);
            if (!listsRef) return;
            
            try {
                createListButton.disabled = true;
                const newListDocRef = doc(listsRef); 
                await setDoc(newListDocRef, {
                    name: listName,
                    created: serverTimestamp()
                });
                
                newListInput.value = '';
                switchToList(newListDocRef.id, listName);
                showMessage("Success", `List "${listName}" created!`);

            } catch (error) {
                displayError("Failed to create new list: " + error.message);
            } finally {
                createListButton.disabled = false;
            }
        });

        // 3. Add Item to Current List
        addItemButton.addEventListener('click', async () => {
            const term = termInput.value.trim();
            const definition = definitionInput.value.trim();

            if (!currentListId) {
                showMessage("Action Required", "Please select or create a list before adding items.");
                return;
            }
            if (!term || !definition) {
                displayError("Both term and definition are required.");
                return;
            }
            
            const itemsRef = getListItemsCollectionRef(currentListId);
            if (!itemsRef) return;

            try {
                addItemButton.disabled = true;
                await addDoc(itemsRef, {
                    term: term,
                    definition: definition,
                    created: serverTimestamp()
                });
                
                termInput.value = '';
                definitionInput.value = '';
                errorMessage.classList.add('hidden');

            } catch (error) {
                displayError("Failed to add item: " + error.message);
            } finally {
                addItemButton.disabled = false;
            }
        });

        // 4. Delete Item from Current List
        async function handleDeleteItem(itemId) {
            if (!currentListId) return;
            
            const itemsRef = getListItemsCollectionRef(currentListId);
            try {
                const itemDocRef = doc(itemsRef, itemId);
                await deleteDoc(itemDocRef);
            } catch (error) {
                displayError("Failed to delete item: " + error.message);
            }
        }
        
        // --- Firebase Initialization ---
        // Refactored to be linear and explicitly await sign-in before resolving the sync promise.

        async function initializeFirebase() {
            setLogLevel('debug');
            
            if (Object.keys(firebaseConfig).length === 0) {
                nameErrorMessage.textContent = "FATAL ERROR: Firebase configuration is missing.";
                firebaseInitResolve(); // Resolve promise to unlock UI even on failure
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Set persistence
                await setPersistence(auth, browserLocalPersistence); 

                // 2. Perform the sign-in directly and await its completion
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                    console.log("[DEBUG] Signed in with Custom Token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("[DEBUG] Signed in Anonymously.");
                }
                
                // 3. GUARANTEE RESOLUTION: The critical promise is resolved now that auth is established.
                firebaseInitResolve(); 

            } catch (error) {
                nameErrorMessage.textContent = "Firebase authentication failed: " + error.message;
                console.error("Firebase Initialization Error:", error);
                
                // 4. GUARANTEE RESOLUTION: Resolve even if there was an error, to unblock the UI.
                firebaseInitResolve(); 
            }
        }
        
        // Start the application setup
        initializeFirebase();

    </script>
</body>
</html>
